<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Luy·ªán T·∫≠p Pinyin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Mulish:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Reset CSS c∆° b·∫£n */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Ki·ªÉu d√°ng body */
        body {
            font-family: 'Mulish', sans-serif; /* S·ª≠ d·ª•ng font Mulish l√†m ch√≠nh */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Thay ƒë·ªïi th√†nh flex-start ƒë·ªÉ kh√¥ng b·ªã tr√†n tr√™n di ƒë·ªông */
            padding: 10px;
            overflow-x: hidden;
        }

        /* Ki·ªÉu d√°ng container ch√≠nh */
        .container {
            background: white;
            border-radius: 20px;
            padding: 20px; /* Gi·∫£m padding m·ªôt ch√∫t */
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
            margin: 10px 0; /* Th√™m margin ƒë·ªÉ cƒÉn gi·ªØa t·ªët h∆°n */
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        /* Ki·ªÉu d√°ng ph·∫ßn header */
        .header {
            margin-bottom: 20px; /* Gi·∫£m margin-bottom */
        }

        /* Ti√™u ƒë·ªÅ ch√≠nh */
        .title {
            font-size: clamp(1.8em, 5vw, 2.5em); /* Responsive font size */
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* Ti√™u ƒë·ªÅ ph·ª• */
        .subtitle {
            font-size: clamp(0.9em, 3vw, 1.1em); /* Responsive font size */
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        /* Practice Selector Section - New */
        .practice-selector {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #2196F3;
        }
        
        .practice-selector h3 {
            margin-top: 0;
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: clamp(1em, 4vw, 1.2em);
        }
        
        .student-info {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .student-info label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: clamp(1em, 3vw, 1.1em);
        }
        
        .student-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: clamp(1em, 3vw, 1.1em);
            font-weight: 500;
            background: white;
            transition: all 0.3s ease;
            font-family: 'Mulish', sans-serif;
        }
        
        .student-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .student-input::placeholder {
            color: #999;
            font-weight: normal;
        }
        
        .student-input.error {
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
        }
        
        .dropdown-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .practice-dropdown {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: clamp(0.9em, 3vw, 1.1em);
            font-weight: 600;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            font-family: 'Mulish', sans-serif;
        }
        
        .practice-dropdown:hover {
            border-color: #2196F3;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.2);
        }
        
        .practice-dropdown:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .load-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: clamp(0.9em, 3vw, 1.1em);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-family: 'Mulish', sans-serif;
            min-width: 120px;
            white-space: nowrap;
            -webkit-tap-highlight-color: rgba(33, 150, 243, 0.3);
            user-select: none;
        }
        
        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        .load-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            display: none;
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            color: #856404;
            font-size: clamp(0.9em, 3vw, 1em);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            font-size: clamp(0.9em, 3vw, 1em);
        }
        
        .practice-info {
            margin-top: 15px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            color: #1976d2;
            font-size: clamp(0.9em, 3vw, 1em);
            display: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .action-btn {
            padding: 12px 24px; /* Slightly larger padding for better touch */
            border: none;
            border-radius: 8px;
            font-size: clamp(1em, 3vw, 1.1em); /* Adjusted font size */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 150px;
            max-width: 200px;
            justify-content: center;
        }
        
        .start-game-btn { /* Renamed for clarity */
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Game Section */
        .game-section {
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, s·∫Ω hi·ªÉn th·ªã khi game b·∫Øt ƒë·∫ßu */
        }

        /* Ki·ªÉu d√°ng ph·∫ßn th·ªëng k√™ */
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Cho ph√©p xu·ªëng d√≤ng tr√™n m√†n h√¨nh nh·ªè */
            padding: 15px; /* Th√™m padding */
            background: #f8f9fa; /* Th√™m background */
            border-radius: 15px; /* Bo g√≥c */
        }

        /* M·ªói m·ª•c th·ªëng k√™ */
        .stat-item {
            background: #f8f9fa; /* Background ·∫©n ƒëi ƒë·ªÉ ch·ªâ hi·ªán background c·ªßa stats */
            padding: 0; /* Lo·∫°i b·ªè padding ƒë·ªÉ kh√¥ng t·∫°o kho·∫£ng tr·∫Øng th·ª´a */
            border-left: none; /* Lo·∫°i b·ªè border */
            margin: 5px; 
            flex: 1;
            min-width: 120px;
        }
        
        .stat-item > div { /* √Åp d·ª•ng padding tr·ª±c ti·∫øp cho n·ªôi dung */
            padding: 15px 20px;
            border-radius: 12px;
            border-left: 4px solid #3498db;
            background: white; /* Th√™m l·∫°i background tr·∫Øng cho t·ª´ng item */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Th√™m box-shadow nh·∫π */
        }

        /* Nh√£n c·ªßa m·ª•c th·ªëng k√™ */
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Gi√° tr·ªã c·ªßa m·ª•c th·ªëng k√™ */
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 5px;
        }

        /* Khu v·ª±c ch∆°i game */
        .game-area {
            margin-bottom: 30px;
        }

        /* T·ª´ hi·ªán t·∫°i hi·ªÉn th·ªã */
        .current-word {
            background: #e8f4fd;
            border: 2px solid #3498db;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        /* Nh√£n t·ª´ hi·ªán t·∫°i */
        .current-word-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        /* Hi·ªÉn th·ªã t·ª´ hi·ªán t·∫°i */
        .current-word-display {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .chinese-text-display { /* New style for Chinese text display */
            font-family: 'Noto Sans SC', sans-serif; /* S·ª≠ d·ª•ng font Noto Sans SC cho ti·∫øng Trung */
            font-size: clamp(3em, 15vw, 5em);
            color: #d32f2f;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            margin-bottom: 10px;
        }
        .chinese-text-display:hover {
            transform: scale(1.1);
            color: #b71c1c;
        }

        .meaning-display { /* New style for meaning display */
            font-size: clamp(1.1em, 4vw, 1.4em);
            color: #666;
            margin-bottom: 10px;
            font-weight: 400;
            font-style: italic;
        }

        .audio-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 50%;
            width: clamp(45px, 12vw, 60px);
            height: clamp(45px, 12vw, 60px);
            font-size: clamp(1.2em, 4vw, 1.5em);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            margin: 10px auto;
            touch-action: manipulation;
        }
        
        .audio-btn:hover, .audio-btn:active {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        
        .audio-btn.playing {
            animation: pulse 1s infinite;
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .audio-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .audio-btn.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: none;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* L∆∞·ªõi pinyin */
        .pinyin-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px;
            margin-bottom: 25px;
        }

        /* √î pinyin */
        .pinyin-cell {
            background: #ffffff;
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation; /* Th√™m ƒë·ªÉ t·ªëi ∆∞u h√≥a ch·∫°m */
        }

        /* Hi·ªáu ·ª©ng hover cho √¥ pinyin */
        .pinyin-cell:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2);
        }

        /* Ki·ªÉu d√°ng cho √¥ pinyin ƒë√∫ng */
        .pinyin-cell.correct {
            background: #d5f4e6;
            border-color: #27ae60;
            color: #27ae60;
            animation: correctPulse 0.8s ease-in-out;
        }

        /* Ki·ªÉu d√°ng cho √¥ pinyin sai */
        .pinyin-cell.incorrect {
            background: #ffeaea;
            border-color: #e74c3c;
            color: #e74c3c;
            animation: incorrectShake 0.5s ease-in-out;
        }

        /* Ki·ªÉu d√°ng cho √¥ pinyin b·ªã ·∫©n ho√†n to√†n */
        .pinyin-cell.hidden {
            visibility: hidden; /* D√πng visibility ƒë·ªÉ gi·ªØ v·ªã tr√≠ trong grid */
            pointer-events: none; /* V√¥ hi·ªáu h√≥a t∆∞∆°ng t√°c chu·ªôt/ch·∫°m */
            opacity: 0;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        /* Ki·ªÉu d√°ng cho √¥ pinyin b·ªã v√¥ hi·ªáu h√≥a */
        .pinyin-cell.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Keyframe cho hi·ªáu ·ª©ng rung l·∫Øc */
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Khu v·ª±c ƒëi·ªÅu khi·ªÉn (n√∫t b·∫•m) */
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        /* Ki·ªÉu d√°ng n√∫t b·∫•m chung */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Mulish', sans-serif;
            touch-action: manipulation;
        }

        /* N√∫t ch√≠nh */
        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        /* N√∫t ph·ª• */
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        /* N√∫t th√†nh c√¥ng */
        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        /* Thanh ti·∫øn ƒë·ªô */
        .progress-bar {
            background: #ecf0f1;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        /* Thanh ti·∫øn ƒë·ªô ƒë·∫ßy */
        .progress-fill {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Modal k·∫øt qu·∫£ - Enhanced */
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 10px; /* Th√™m padding cho modal tr√™n di ƒë·ªông */
        }

        /* N·ªôi dung modal k·∫øt qu·∫£ */
        .result-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px; /* TƒÉng max-width */
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .result-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        /* Ti√™u ƒë·ªÅ modal k·∫øt qu·∫£ */
        .result-title {
            font-size: clamp(1.8em, 5vw, 2.5em);
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .result-title span {
            color: #667eea; /* Color for student name */
        }

        /* Th·ªëng k√™ trong modal k·∫øt qu·∫£ */
        .result-stats {
            margin-bottom: 30px;
        }

        /* M·ªói m·ª•c th·ªëng k√™ trong modal */
        .result-stat {
            margin-bottom: 15px;
        }

        /* Nh√£n th·ªëng k√™ trong modal */
        .result-stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Gi√° tr·ªã th·ªëng k√™ trong modal */
        .result-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3498db;
        }

        /* M√†u s·∫Øc ƒë·ªô ch√≠nh x√°c cao */
        .accuracy-high { color: #27ae60; }
        /* M√†u s·∫Øc ƒë·ªô ch√≠nh x√°c trung b√¨nh */
        .accuracy-medium { color: #f39c12; }
        /* M√†u s·∫Øc ƒë·ªô ch√≠nh x√°c th·∫•p */
        .accuracy-low { color: #e74c3c; }

        .result-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .result-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: clamp(0.9em, 3vw, 1.1em);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-family: 'Mulish', sans-serif;
            touch-action: manipulation;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .reset-btn {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }
        
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }
        
        .back-to-selection-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }
        
        .back-to-selection-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.3);
        }

        .audio-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: clamp(0.8em, 2.5vw, 0.9em);
            display: none;
        }

        .audio-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .audio-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Media queries cho thi·∫øt b·ªã di ƒë·ªông */
        @media (max-width: 600px) {
            body {
                padding: 0; /* Lo·∫°i b·ªè padding tr√™n body ƒë·ªÉ container chi·∫øm to√†n m√†n h√¨nh */
            }

            .container {
                border-radius: 0; /* Lo·∫°i b·ªè bo g√≥c tr√™n container */
                min-height: 100vh; /* Chi·∫øm to√†n b·ªô chi·ªÅu cao m√†n h√¨nh */
                padding: 15px; /* Gi·∫£m padding */
                display: flex;
                flex-direction: column;
                justify-content: space-between; /* ƒê·∫©y n·ªôi dung ra xa nhau */
                margin: 0; /* Lo·∫°i b·ªè margin */
            }
            
            .stats {
                flex-direction: row; /* Gi·ªØ c√°c m·ª•c th·ªëng k√™ tr√™n m·ªôt h√†ng */
                justify-content: space-between; /* Ph√¢n b·ªï ƒë·ªÅu kh√¥ng gian */
                gap: 5px; /* Gi·∫£m kho·∫£ng c√°ch gi·ªØa c√°c m·ª•c */
            }
            
            .stat-item {
                padding: 10px 15px; /* Gi·∫£m padding */
                min-width: unset; /* B·ªè min-width ƒë·ªÉ co gi√£n t·ªët h∆°n */
                flex: 1; /* ƒê·∫£m b·∫£o c√°c m·ª•c chi·∫øm kh√¥ng gian ƒë·ªÅu */
            }

            .stat-label {
                font-size: 10px; /* Gi·∫£m k√≠ch th∆∞·ªõc font */
            }

            .stat-value {
                font-size: 20px; /* Gi·∫£m k√≠ch th∆∞·ªõc font */
            }
            
            .controls {
                flex-direction: column;
            }
            
            .pinyin-cell {
                padding: 15px;
                font-size: 16px;
                min-height: 60px;
            }

            .dropdown-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .practice-dropdown {
                width: 100%;
                min-width: auto;
                max-width: none;
            }
            
            .load-btn {
                width: 100%;
                min-width: auto;
            }

            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                min-width: auto;
                max-width: none;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            body {
                padding: 2px;
            }
            
            .container {
                padding: 10px;
                margin: 2px 0;
            }
            
            .practice-selector {
                padding: 10px;
            }
            
            .game-area {
                padding: 5px;
            }
            
            .pinyin-grid {
                gap: 10px;
            }
            
            .pinyin-cell {
                padding: 10px;
                font-size: 14px;
            }
        }

        /* Landscape mobile optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                min-height: auto;
            }
            
            .chinese-text-display {
                font-size: clamp(2.5em, 12vw, 4em);
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .pinyin-cell:hover {
                border-color: #ecf0f1;
                transform: none;
                box-shadow: none;
            }
            
            .audio-btn:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            }
            
            .btn:hover, .action-btn:hover, .reset-btn:hover, .back-to-selection-btn:hover, .load-btn:hover {
                transform: none;
            }
            
            /* Better touch targets for mobile */
            button, .pinyin-cell {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Improve button press feedback on touch devices */
            button:active, .pinyin-cell:active:not(.disabled) {
                opacity: 0.8;
                transform: scale(0.98);
            }
            
            /* Ensure animations work on touch devices */
            .pinyin-cell.correct {
                animation: correctPulse 0.8s ease-in-out !important;
            }
            
            .pinyin-cell.incorrect {
                animation: incorrectShake 0.5s ease-in-out !important;
            }
        }

        /* High DPI screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .chinese-text-display {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üéß Luy·ªán T·∫≠p Pinyin</h1>
            <p class="subtitle">Nghe v√† ch·ªçn pinyin ƒë√∫ng t·ª´ l∆∞·ªõi</p>
        </div>

        <!-- Practice Selection Section -->
        <div class="practice-selector" id="practice-selector">
            <h3>üéØ Th√¥ng tin h·ªçc sinh v√† B√†i luy·ªán t·∫≠p:</h3>
            
            <!-- Student Name Input -->
            <div class="student-info">
                <label for="student-name">üë®‚Äçüéì T√™n h·ªçc sinh:</label>
                <input type="text" id="student-name" class="student-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="50">
            </div>
            
            <div class="dropdown-container">
                <select class="practice-dropdown" id="practice-dropdown">
                    <option value="">Ch·ªçn b√†i luy·ªán t·∫≠p...</option>
                </select>
                <button class="load-btn" id="load-btn">üöÄ T·∫£i B√†i</button>
            </div>
            <div class="loading" id="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>
            <div class="error" id="error"></div>
            <div class="practice-info" id="practice-info"></div>
        </div>

        <!-- Game Section -->
        <div class="game-section" id="game-section">
            <div class="stats">
                <div class="stat-item">
                    <div>
                        <div class="stat-label">ƒêi·ªÉm s·ªë</div>
                        <div class="stat-value" id="score">0</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div>
                        <div class="stat-label">Ti·∫øn ƒë·ªô</div>
                        <div class="stat-value" id="progress">0/0</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div>
                        <div class="stat-label">ƒê·ªô ch√≠nh x√°c</div>
                        <div class="stat-value" id="accuracy">0%</div>
                    </div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="game-area">
                <div class="current-word">
                    <div class="current-word-label">T·ª´ hi·ªán t·∫°i:</div>
                    <div class="chinese-text-display" id="chineseTextDisplay">B·∫•m "B·∫Øt ƒë·∫ßu"</div>
                    <div class="meaning-display" id="meaningDisplay">ƒë·ªÉ ch∆°i</div>
                    <button class="audio-btn" id="audioBtn" title="Ph√°t √¢m">üîä</button>
                    <div id="audio-status" class="audio-status"></div>
                </div>

                <div class="pinyin-grid" id="pinyinGrid">
                    <!-- C√°c √¥ pinyin s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn">B·∫Øt ƒë·∫ßu</button>
                <button class="btn btn-success" id="newGameBtn" style="display: none;">Ch∆°i l·∫°i</button>
            </div>
        </div>
    </div>

    <!-- Modal k·∫øt qu·∫£ -->
    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <h2 class="result-title">K·∫øt qu·∫£ luy·ªán t·∫≠p c·ªßa <span></span></h2>
            <div style="font-size: clamp(1.1em, 3.5vw, 1.3em); color: #666; margin-bottom: 10px;">
                üìö <span id="finalPracticeName"></span>
            </div>
            <div style="font-size: clamp(1em, 3vw, 1.2em); color: #888; margin-bottom: 15px;">
                üî¢ L·∫ßn n·ªôp: <span id="finalAttemptCount">0</span>
            </div>
            <div class="result-stats">
                <div class="result-stat">
                    <div class="result-stat-label">T·ªïng ƒëi·ªÉm</div>
                    <div class="result-stat-value" id="finalScore">0</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">ƒê·ªô ch√≠nh x√°c</div>
                    <div class="result-stat-value" id="finalAccuracy">0%</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">S·ªë l·∫ßn th·ª≠</div>
                    <div class="result-stat-value" id="totalAttempts">0</div>
                </div>
            </div>
            <div style="font-size: clamp(1.1em, 3.5vw, 1.4em); margin-bottom: 10px; color: #4CAF50; font-weight: 600;" id="personalMessage"></div>
            <div style="font-size: clamp(1em, 3vw, 1.3em); margin-bottom: 20px;" id="overallMessage"></div>

            <div class="result-buttons">
                <button class="result-btn reset-btn" id="modalResetBtn">üîÑ Ch∆°i l·∫°i</button>
                <button class="result-btn back-to-selection-btn" id="modalBackToSelectionBtn">üìö Ch·ªçn b√†i kh√°c</button>
            </div>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh c√°c b√†i luy·ªán t·∫≠p v√† ƒë∆∞·ªùng d·∫´n
        const CONFIG = {
            dataPath: 'data_pinyinPractice/', // ƒê∆∞·ªùng d·∫´n t·ªõi th∆∞ m·ª•c ch·ª©a d·ªØ li·ªáu b√†i h·ªçc
            practices: [
                { id: 'practice1', name: 'üìö Luy·ªán T·∫≠p 1' },
                { id: 'practice2', name: 'üìö Luy·ªán T·∫≠p 2' },
                { id: 'practice3', name: 'üìö Luy·ªán T·∫≠p 3 ' },
                { id: 'practice4', name: 'üìö Luy·ªán T·∫≠p 4 ' },
                { id: 'practice5', name: 'üìö Luy·ªán T·∫≠p 5 ' },
                { id: 'practice6', name: 'üìö Luy·ªán T·∫≠p 6 ' },
                { id: 'practice7', name: 'üìö Luy·ªán T·∫≠p 7 ' },
                { id: 'practice8', name: 'üìö Luy·ªán T·∫≠p 8 ' },
                { id: 'practice9', name: 'üìö Luy·ªán T·∫≠p 9 ' },
                { id: 'practice10', name: 'üìö Luy·ªán T·∫≠p 10 ' },
                { id: 'practice11', name: 'üìö Luy·ªán T·∫≠p 11 ' },
                { id: 'practice12', name: 'üìö Luy·ªán T·∫≠p 12 ' },
                { id: 'practice13', name: 'üìö Luy·ªán T·∫≠p 13 ' },
                { id: 'practice14', name: 'üìö Luy·ªán T·∫≠p 14 ' },
                { id: 'practice15', name: 'üìö Luy·ªán T·∫≠p 15 ' },
                { id: 'practice16', name: 'üìö Luy·ªán T·∫≠p 16 ' }
            ]
        };

        // D·ªØ li·ªáu demo d·ª± ph√≤ng n·∫øu kh√¥ng t·∫£i ƒë∆∞·ª£c file
        const demoData = {
            practice1: `‰Ω†Â•Ω|xin ch√†o|n«ê h«éo|xi√® xi√®|du√¨ bu q«ê|*n«ê h«éo
Ë∞¢Ë∞¢|c·∫£m ∆°n|n«ê h«éo|*xi√® xi√®|du√¨ bu q«ê|z√†i ji√†n
ÂØπ‰∏çËµ∑|xin l·ªói|xi√® xi√®|z√†i ji√†n|*du√¨ bu q«ê|m√©i guƒÅn x√¨
ÂÜçËßÅ|t·∫°m bi·ªát|m√©i guƒÅn x√¨|q«êng w√®n|*z√†i ji√†n|b√∫ k√® q√¨
Ê≤°ÂÖ≥Á≥ª|kh√¥ng sao|q«êng w√®n|b√∫ k√® q√¨|*m√©i guƒÅn x√¨|du≈ç sh«éo qi√°n
ËØ∑ÈóÆ|xin h·ªèi|b√∫ k√® q√¨|du≈ç sh«éo qi√°n|*q«êng w√®n|m√≠ng tiƒÅn ji√†n
‰∏çÂÆ¢Ê∞î|kh√¥ng c√≥ g√¨|du≈ç sh«éo qi√°n|m√≠ng tiƒÅn ji√†n|*b√∫ k√® q√¨|n«ê h«éo
Â§öÂ∞ëÈí±|bao nhi√™u ti·ªÅn|m√≠ng tiƒÅn ji√†n|n«ê h«éo|*du≈ç sh«éo qi√°n|xi√® xi√®
ÊòéÂ§©ËßÅ|h·∫πn g·∫∑p l·∫°i ng√†y mai|xi√® xi√®|du√¨ bu q«ê|*m√≠ng tiƒÅn ji√†n|z√†i ji√†n`
        };

        class PinyinGame {
            constructor() {
                this.words = []; // Danh s√°ch c√°c t·ª´ Pinyin ƒë·ªÉ luy·ªán t·∫≠p, s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ file
                
                // Kh·ªüi t·∫°o c√°c bi·∫øn tr·∫°ng th√°i game
                this.currentWordIndex = 0; // Ch·ªâ s·ªë c·ªßa t·ª´ hi·ªán t·∫°i trong m·∫£ng words ƒë√£ x√°o tr·ªôn
                this.score = 0; // ƒêi·ªÉm s·ªë c·ªßa ng∆∞·ªùi ch∆°i
                this.correctAnswers = 0; // S·ªë c√¢u tr·∫£ l·ªùi ƒë√∫ng
                this.totalAttempts = 0; // T·ªïng s·ªë l·∫ßn th·ª≠ (s·ªë l·∫ßn ch·ªçn √¥ pinyin)
                this.gameStarted = false; // Tr·∫°ng th√°i game ƒë√£ b·∫Øt ƒë·∫ßu hay ch∆∞a
                this.isPlaying = false; // Tr·∫°ng th√°i ƒëang ch∆°i (ƒëang ch·ªù ng∆∞·ªùi d√πng ch·ªçn pinyin)
                this.currentAudio = null; // ƒê·ªëi t∆∞·ª£ng Audio hi·ªán t·∫°i
                this.studentName = ''; // T√™n h·ªçc sinh
                this.currentPracticeId = ''; // ID c·ªßa b√†i luy·ªán t·∫≠p hi·ªán t·∫°i
                this.attemptCount = 0; // S·ªë l·∫ßn ho√†n th√†nh game

                // M·∫£ng l∆∞u tr·ªØ d·ªØ li·ªáu cho 9 √¥ pinyin tr√™n l∆∞·ªõi. M·ªói √¥ c√≥ pinyin v√† tr·∫°ng th√°i (·∫©n/hi·ªán)
                this.gridPinyinCellsData = []; 

                // Kh·ªüi t·∫°o c√°c ph·∫ßn t·ª≠ DOM
                this.initializeElements();
                // Thi·∫øt l·∫≠p c√°c s·ª± ki·ªán l·∫Øng nghe
                this.setupEventListeners();
                // Kh·ªüi t·∫°o giao di·ªán ch·ªçn b√†i h·ªçc
                this.initializePracticeSelector();
            }

            /**
             * Kh·ªüi t·∫°o c√°c tham chi·∫øu ƒë·∫øn c√°c ph·∫ßn t·ª≠ DOM.
             */
            initializeElements() {
                this.practiceSelector = document.getElementById('practice-selector');
                this.studentNameInput = document.getElementById('student-name');
                this.practiceDropdown = document.getElementById('practice-dropdown');
                this.loadBtn = document.getElementById('load-btn');
                this.loadingIndicator = document.getElementById('loading');
                this.errorDisplay = document.getElementById('error');
                this.practiceInfoDisplay = document.getElementById('practice-info');
                this.gameSection = document.getElementById('game-section');

                this.scoreElement = document.getElementById('score');
                this.progressElement = document.getElementById('progress');
                this.accuracyElement = document.getElementById('accuracy');
                this.progressFillElement = document.getElementById('progressFill');
                this.chineseTextDisplay = document.getElementById('chineseTextDisplay');
                this.meaningDisplay = document.getElementById('meaningDisplay');
                this.audioBtn = document.getElementById('audioBtn');
                this.audioStatus = document.getElementById('audio-status');
                this.pinyinGridElement = document.getElementById('pinyinGrid');
                this.startBtn = document.getElementById('startBtn');
                this.newGameBtn = document.getElementById('newGameBtn');
                this.resultModal = document.getElementById('resultModal');
                this.resultTitle = this.resultModal.querySelector('.result-title span');
                this.finalPracticeName = document.getElementById('finalPracticeName');
                this.finalAttemptCount = document.getElementById('finalAttemptCount');
                this.finalScore = document.getElementById('finalScore');
                this.finalAccuracy = document.getElementById('finalAccuracy');
                this.totalAttemptsModal = document.getElementById('totalAttempts');
                this.personalMessage = document.getElementById('personalMessage');
                this.overallMessage = document.getElementById('overallMessage');
                this.modalResetBtn = document.getElementById('modalResetBtn');
                this.modalBackToSelectionBtn = document.getElementById('modalBackToSelectionBtn');
            }

            /**
             * Thi·∫øt l·∫≠p c√°c s·ª± ki·ªán l·∫Øng nghe cho c√°c n√∫t b·∫•m v√† dropdown.
             */
            setupEventListeners() {
                this.loadBtn.addEventListener('click', () => this.loadPractice());
                this.startBtn.addEventListener('click', () => this.startGame());
                this.newGameBtn.addEventListener('click', () => this.resetGame());
                this.audioBtn.addEventListener('click', () => this.playCurrentWordAudio());
                this.modalResetBtn.addEventListener('click', () => this.resetGame());
                this.modalBackToSelectionBtn.addEventListener('click', () => this.backToSelection());

                // ƒê√≥ng modal khi click ra b√™n ngo√†i n·ªôi dung modal
                this.resultModal.addEventListener('click', (e) => {
                    if (e.target === this.resultModal) {
                        this.resultModal.style.display = 'none';
                    }
                });
            }

            /**
             * Kh·ªüi t·∫°o giao di·ªán ch·ªçn b√†i h·ªçc: ƒëi·ªÅn dropdown.
             */
            initializePracticeSelector() {
                this.practiceDropdown.innerHTML = '<option value="">Ch·ªçn b√†i luy·ªán t·∫≠p...</option>';
                CONFIG.practices.forEach(practice => {
                    const option = document.createElement('option');
                    option.value = practice.id;
                    option.textContent = practice.name;
                    this.practiceDropdown.appendChild(option);
                });
                this.showElement(this.practiceSelector);
                this.hideElement(this.gameSection);
            }

            /**
             * T·∫£i d·ªØ li·ªáu b√†i h·ªçc t·ª´ file.
             */
            async loadPractice() {
                this.studentName = this.studentNameInput.value.trim();
                this.currentPracticeId = this.practiceDropdown.value;

                // Validate student name
                if (!this.studentName) {
                    this.showError('Vui l√≤ng nh·∫≠p t√™n h·ªçc sinh!');
                    this.studentNameInput.classList.add('error');
                    this.studentNameInput.focus();
                    return;
                }
                this.studentNameInput.classList.remove('error');

                // Validate practice selection
                if (!this.currentPracticeId) {
                    this.showError('Vui l√≤ng ch·ªçn m·ªôt b√†i luy·ªán t·∫≠p!');
                    return;
                }
                
                this.showLoading(true);
                this.hideError();

                try {
                    let fileContent;
                    let isUsingDemo = false;
                    
                    const txtPath = `${CONFIG.dataPath}${this.currentPracticeId}/${this.currentPracticeId}.txt`;
                    
                    try {
                        const response = await fetch(txtPath);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        fileContent = await response.text();
                    } catch (error) {
                        console.warn(`Failed to load file from ${txtPath}:`, error);
                        if (demoData[this.currentPracticeId]) {
                            fileContent = demoData[this.currentPracticeId];
                            isUsingDemo = true;
                        } else {
                            throw new Error(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho b√†i "${this.currentPracticeId}".`);
                        }
                    }

                    if (isUsingDemo) {
                        this.showError(`‚ö†Ô∏è ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu demo cho b√†i "${this.currentPracticeId}". ƒê·ªÉ d√πng file th·∫≠t, h√£y ƒë·∫∑t file t·∫°i: ${txtPath}`);
                        setTimeout(() => this.hideError(), 6000);
                    }
                    
                    this.words = this.parsePracticeData(fileContent);

                    if (this.words.length === 0) {
                        throw new Error('Kh√¥ng t√¨m th·∫•y t·ª´ h·ª£p l·ªá trong file b√†i h·ªçc!');
                    }
                    
                    this.showPracticeInfo();
                    this.showLoading(false);
                    this.startBtn.disabled = false; // K√≠ch ho·∫°t n√∫t B·∫Øt ƒë·∫ßu
                    this.shuffleWords(); // Tr·ªôn t·ª´ sau khi t·∫£i
                    this.prepareAndRenderInitialGrid(); // Chu·∫©n b·ªã l∆∞·ªõi pinyin ban ƒë·∫ßu
                    this.updateStats(); // C·∫≠p nh·∫≠t th·ªëng k√™ ban ƒë·∫ßu
                    this.chineseTextDisplay.textContent = 'B·∫•m "B·∫Øt ƒë·∫ßu"';
                    this.meaningDisplay.textContent = 'ƒë·ªÉ ch∆°i';

                } catch (error) {
                    console.error('Error loading practice:', error);
                    this.showError(error.message);
                    this.showLoading(false);
                    this.startBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t B·∫Øt ƒë·∫ßu n·∫øu c√≥ l·ªói
                }
            }

            /**
             * Ph√¢n t√≠ch d·ªØ li·ªáu b√†i h·ªçc t·ª´ chu·ªói vƒÉn b·∫£n.
             * @param {string} dataString - Chu·ªói d·ªØ li·ªáu t·ª´ file .txt.
             * @returns {Array<Object>} M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng t·ª´.
             */
            parsePracticeData(dataString) {
                const lines = dataString.trim().split('\n');
                const parsedWords = [];
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const parts = line.split('|');
                    // C·∫•u tr√∫c: ti·∫øng trung|pinyin|nghƒ©a. (Ch·ªâ l·∫•y 3 ph·∫ßn ƒë·∫ßu)
                    if (parts.length >= 3) { 
                        parsedWords.push({
                            chinese: parts[0].trim(),
                            pinyin: parts[1].trim(),
                            meaning: parts[2].trim()
                        });
                    } else {
                        console.warn(`D√≤ng ${i + 1} c√≥ format kh√¥ng ƒë√∫ng: ${line}`);
                    }
                }
                return parsedWords;
            }

            /**
             * Hi·ªÉn th·ªã th√¥ng tin b√†i h·ªçc ƒë√£ ch·ªçn.
             */
            showPracticeInfo() {
                const practiceName = CONFIG.practices.find(p => p.id === this.currentPracticeId)?.name || this.currentPracticeId;
                this.practiceInfoDisplay.innerHTML = `
                    <strong>üë®‚Äçüéì H·ªçc sinh: ${this.studentName}</strong><br>
                    <strong>üìö ${practiceName}</strong><br>
                    S·ªë t·ª´: ${this.words.length}<br>
                    <div class="action-buttons">
                        <button class="action-btn start-game-btn" onclick="game.startGame()">
                            üéØ B·∫Øt ƒë·∫ßu Game
                        </button>
                    </div>
                `;
                this.showElement(this.practiceInfoDisplay);
            }

            /**
             * Hi·ªÉn th·ªã/·∫©n loading indicator.
             * @param {boolean} show - True ƒë·ªÉ hi·ªÉn th·ªã, False ƒë·ªÉ ·∫©n.
             */
            showLoading(show) {
                this.loadingIndicator.style.display = show ? 'block' : 'none';
                this.loadBtn.disabled = show;
                this.practiceDropdown.disabled = show;
                this.studentNameInput.disabled = show;
            }

            /**
             * Hi·ªÉn th·ªã th√¥ng b√°o l·ªói.
             * @param {string} message - N·ªôi dung l·ªói.
             */
            showError(message) {
                this.errorDisplay.textContent = message;
                this.errorDisplay.style.display = 'block';
            }

            /**
             * ·∫®n th√¥ng b√°o l·ªói.
             */
            hideError() {
                this.errorDisplay.style.display = 'none';
            }

            /**
             * Hi·ªÉn th·ªã m·ªôt ph·∫ßn t·ª≠ DOM.
             * @param {HTMLElement} element - Ph·∫ßn t·ª≠ c·∫ßn hi·ªÉn th·ªã.
             */
            showElement(element) {
                element.style.display = 'block';
            }

            /**
             * ·∫®n m·ªôt ph·∫ßn t·ª≠ DOM.
             * @param {HTMLElement} element - Ph·∫ßn t·ª≠ c·∫ßn ·∫©n.
             */
            hideElement(element) {
                element.style.display = 'none';
            }

            /**
             * Chu·∫©n b·ªã d·ªØ li·ªáu cho 9 √¥ pinyin ban ƒë·∫ßu v√† render ch√∫ng.
             * C√°c √¥ n√†y s·∫Ω c·ªë ƒë·ªãnh trong su·ªët tr√≤ ch∆°i.
             */
            prepareAndRenderInitialGrid() {
                // L·∫•y t·∫•t c·∫£ c√°c pinyin duy nh·∫•t t·ª´ danh s√°ch t·ª´ ƒë√£ t·∫£i
                let allUniquePinyin = Array.from(new Set(this.words.map(word => word.pinyin)));
                
                // ƒê·∫£m b·∫£o c√≥ ƒë·ªß 9 pinyin. N·∫øu √≠t h∆°n, c√≥ th·ªÉ l·∫∑p l·∫°i ho·∫∑c th√™m pinyin gi·∫£.
                while (allUniquePinyin.length < 9) {
                    if (this.words.length > 0) {
                        const randomIndex = Math.floor(Math.random() * this.words.length);
                        allUniquePinyin.push(this.words[randomIndex].pinyin);
                        allUniquePinyin = Array.from(new Set(allUniquePinyin)); // ƒê·∫£m b·∫£o v·∫´n duy nh·∫•t
                    } else {
                        // Fallback if no words loaded (should not happen if loadPractice is successful)
                        allUniquePinyin.push(`pinyin${allUniquePinyin.length + 1}`);
                    }
                }

                // X√°o tr·ªôn c√°c pinyin n√†y ƒë·ªÉ t·∫°o l∆∞·ªõi ban ƒë·∫ßu
                for (let i = allUniquePinyin.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allUniquePinyin[i], allUniquePinyin[j]] = [allUniquePinyin[j], allUniquePinyin[i]];
                }

                // Gi·ªõi h·∫°n 9 √¥ ƒë·∫ßu ti√™n n·∫øu c√≥ nhi·ªÅu h∆°n 9 pinyin duy nh·∫•t
                this.gridPinyinCellsData = allUniquePinyin.slice(0, 9).map(pinyin => ({
                    pinyin: pinyin,
                    isHidden: false,
                    isCorrect: false // ƒê·ªÉ theo d√µi tr·∫°ng th√°i ƒë√∫ng
                }));

                this.renderPinyinGrid();
            }

            /**
             * Render (ho·∫∑c render l·∫°i) l∆∞·ªõi pinyin d·ª±a tr√™n d·ªØ li·ªáu trong gridPinyinCellsData.
             */
            renderPinyinGrid() {
                this.pinyinGridElement.innerHTML = ''; // X√≥a c√°c √¥ hi·ªán c√≥
                this.gridPinyinCellsData.forEach((cellData, index) => {
                    const cell = document.createElement('div');
                    cell.className = 'pinyin-cell';
                    
                    if (cellData.isHidden) {
                        cell.classList.add('hidden'); // Th√™m l·ªõp 'hidden' ƒë·ªÉ ·∫©n √¥ ho√†n to√†n
                    } else {
                        cell.textContent = cellData.pinyin;
                        // Ch·ªâ th√™m event listener n·∫øu √¥ ch∆∞a b·ªã ·∫©n
                        cell.addEventListener('click', () => this.selectCell(index)); 
                    }
                    this.pinyinGridElement.appendChild(cell);
                });
            }

            /**
             * B·∫Øt ƒë·∫ßu tr√≤ ch∆°i.
             */
            startGame() {
                if (this.words.length === 0) {
                    this.showError('Ch∆∞a c√≥ d·ªØ li·ªáu b√†i h·ªçc. Vui l√≤ng ch·ªçn b√†i h·ªçc tr∆∞·ªõc.');
                    return;
                }

                this.hideElement(this.practiceSelector);
                this.showElement(this.gameSection);

                this.gameStarted = true;
                this.startBtn.style.display = 'none'; // ·∫®n n√∫t "B·∫Øt ƒë·∫ßu"
                this.newGameBtn.style.display = 'none'; // ƒê·∫£m b·∫£o n√∫t "Ch∆°i l·∫°i" c≈©ng ·∫©n
                this.currentWordIndex = 0; // ƒê·∫∑t l·∫°i ch·ªâ s·ªë t·ª´ v·ªÅ 0
                this.score = 0;
                this.correctAnswers = 0;
                this.totalAttempts = 0;
                
                // Reset tr·∫°ng th√°i c·ªßa c√°c √¥ pinyin tr√™n l∆∞·ªõi
                this.gridPinyinCellsData.forEach(data => {
                    data.isHidden = false;
                    data.isCorrect = false;
                });
                this.renderPinyinGrid(); // Render l·∫°i l∆∞·ªõi ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£ c√°c √¥

                this.updateStats(); // C·∫≠p nh·∫≠t th·ªëng k√™ ban ƒë·∫ßu
                this.playCurrentWord(); // B·∫Øt ƒë·∫ßu ch∆°i t·ª´ ƒë·∫ßu ti√™n
            }

            /**
             * Ph√°t t·ª´ hi·ªán t·∫°i.
             * L·∫•y t·ª´ hi·ªán t·∫°i v√† ph√°t √¢m.
             */
            playCurrentWord() {
                // Ki·ªÉm tra n·∫øu ƒë√£ h·∫øt t·ª´, k·∫øt th√∫c game
                if (this.currentWordIndex >= this.words.length) {
                    this.endGame();
                    return;
                }

                this.isPlaying = true; // ƒê·∫∑t tr·∫°ng th√°i ƒëang ch∆°i
                const currentWord = this.words[this.currentWordIndex];
                this.chineseTextDisplay.textContent = currentWord.chinese;
                this.meaningDisplay.textContent = currentWord.meaning;
                
                // Ph√°t √¢m t·ª´ ti·∫øng Trung
                this.playCurrentWordAudio();
            }

            /**
             * Ph√°t √¢m t·ª´ ti·∫øng Trung hi·ªán t·∫°i.
             * ∆Øu ti√™n file mp3, n·∫øu l·ªói th√¨ d√πng Web Speech API.
             */
            async playCurrentWordAudio() {
                if (!this.gameStarted || !this.isPlaying) return;

                const currentWord = this.words[this.currentWordIndex];
                const audioFilePath = `${CONFIG.dataPath}${this.currentPracticeId}/mp3/${currentWord.chinese}.mp3`;

                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }

                this.audioBtn.classList.add('playing');
                this.audioBtn.disabled = true;
                this.audioBtn.classList.remove('error');
                this.hideElement(this.audioStatus);

                try {
                    this.currentAudio = new Audio(audioFilePath);
                    this.currentAudio.volume = 1.0;
                    this.currentAudio.playbackRate = 0.8;

                    this.currentAudio.onended = () => {
                        this.audioBtn.classList.remove('playing');
                        this.audioBtn.disabled = false;
                    };

                    this.currentAudio.onerror = (e) => {
                        console.error('Audio file error:', e);
                        this.audioBtn.classList.remove('playing');
                        this.audioBtn.classList.add('error');
                        this.audioBtn.disabled = false;
                        this.showAudioStatus('Kh√¥ng t√¨m th·∫•y file √¢m thanh. S·ª≠ d·ª•ng gi·ªçng ƒë·ªçc t·ªïng h·ª£p.', 'error');
                        this.speakText(currentWord.chinese); // Fallback to text-to-speech
                    };

                    await this.currentAudio.play();
                } catch (error) {
                    console.error('Error playing audio (catch block):', error);
                    this.audioBtn.classList.remove('playing');
                    this.audioBtn.classList.add('error');
                    this.audioBtn.disabled = false;
                    this.showAudioStatus('L·ªói khi ph√°t √¢m thanh. S·ª≠ d·ª•ng gi·ªçng ƒë·ªçc t·ªïng h·ª£p.', 'error');
                    this.speakText(currentWord.chinese); // Fallback to text-to-speech
                }
            }

            /**
             * Ph√°t √¢m vƒÉn b·∫£n s·ª≠ d·ª•ng Web Speech API.
             * @param {string} text - VƒÉn b·∫£n c·∫ßn ph√°t √¢m.
             */
            speakText(text) {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel(); // D·ª´ng b·∫•t k·ª≥ ph√°t √¢m n√†o ƒëang di·ªÖn ra
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN'; // ƒê·∫∑t ng√¥n ng·ªØ l√† ti·∫øng Trung
                    utterance.rate = 0.8; // T·ªëc ƒë·ªô ph√°t √¢m
                    utterance.pitch = 1; // Cao ƒë·ªô ph√°t √¢m
                    speechSynthesis.speak(utterance);

                    utterance.onend = () => {
                        this.audioBtn.classList.remove('playing');
                        this.audioBtn.disabled = false;
                        this.audioBtn.classList.remove('error'); // X√≥a tr·∫°ng th√°i l·ªói n·∫øu TTS th√†nh c√¥ng
                    };
                    utterance.onerror = (e) => {
                        console.error('Text-to-speech error:', e);
                        this.audioBtn.classList.remove('playing');
                        this.audioBtn.classList.add('error');
                        this.audioBtn.disabled = false;
                        this.showAudioStatus('Kh√¥ng th·ªÉ ph√°t √¢m thanh t·ªïng h·ª£p.', 'error');
                    };
                } else {
                    this.showAudioStatus('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API.', 'error');
                    this.audioBtn.classList.remove('playing');
                    this.audioBtn.classList.add('error');
                    this.audioBtn.disabled = false;
                }
            }

            /**
             * Hi·ªÉn th·ªã tr·∫°ng th√°i √¢m thanh.
             * @param {string} message - Tin nh·∫Øn hi·ªÉn th·ªã.
             * @param {string} type - Lo·∫°i tr·∫°ng th√°i ('info', 'error').
             */
            showAudioStatus(message, type) {
                this.audioStatus.textContent = message;
                this.audioStatus.className = `audio-status ${type}`;
                this.showElement(this.audioStatus);
                setTimeout(() => this.hideElement(this.audioStatus), 3000);
            }

            /**
             * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn m·ªôt √¥ pinyin.
             * @param {number} selectedIndex - Ch·ªâ s·ªë c·ªßa √¥ pinyin ƒë∆∞·ª£c ng∆∞·ªùi d√πng ch·ªçn trong m·∫£ng gridPinyinCellsData.
             */
            selectCell(selectedIndex) { 
                // ƒê·∫£m b·∫£o game ƒëang ch·∫°y v√† ƒëang ch·ªù ng∆∞·ªùi d√πng ch·ªçn
                if (!this.gameStarted || !this.isPlaying) return;
                
                const selectedCellData = this.gridPinyinCellsData[selectedIndex];
                const selectedCellElement = this.pinyinGridElement.children[selectedIndex];
                
                // N·∫øu √¥ ƒë√£ b·ªã ·∫©n, kh√¥ng l√†m g√¨ c·∫£
                if (selectedCellData.isHidden) return;

                this.totalAttempts++;
                
                // Ki·ªÉm tra xem l·ª±a ch·ªçn c√≥ ƒë√∫ng kh√¥ng
                if (selectedCellData.pinyin === this.words[this.currentWordIndex].pinyin) { 
                    // N·∫øu ƒë√∫ng
                    selectedCellElement.classList.add('correct'); // Th√™m l·ªõp 'correct' ƒë·ªÉ ƒë·ªïi m√†u
                    this.score += 10; // TƒÉng ƒëi·ªÉm
                    this.correctAnswers++; // TƒÉng s·ªë c√¢u tr·∫£ l·ªùi ƒë√∫ng
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong d·ªØ li·ªáu ƒë·ªÉ √¥ b·ªã ·∫©n
                    selectedCellData.isHidden = true;
                    selectedCellData.isCorrect = true;

                    // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ c√°c √¥ pinyin kh√°c ƒë·ªÉ ngƒÉn ch·∫∑n click k√©p
                    this.disablePinyinGrid(true);
                    this.isPlaying = false; // T·∫°m d·ª´ng t∆∞∆°ng t√°c

                    // Ch·ªù m·ªôt ch√∫t r·ªìi c·∫≠p nh·∫≠t l·∫°i √¥ v√† chuy·ªÉn sang t·ª´ ti·∫øp theo
                    setTimeout(() => {
                        selectedCellElement.classList.remove('correct'); // B·ªè l·ªõp 'correct'
                        this.renderPinyinGrid(); // Render l·∫°i l∆∞·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ·∫©n c·ªßa √¥
                        this.currentWordIndex++; // Chuy·ªÉn sang t·ª´ ti·∫øp theo trong m·∫£ng words
                        this.disablePinyinGrid(false); // K√≠ch ho·∫°t l·∫°i l∆∞·ªõi
                        this.playCurrentWord(); // Ph√°t t·ª´ m·ªõi
                    }, 1000);
                } else {
                    // N·∫øu sai
                    selectedCellElement.classList.add('incorrect'); // Th√™m l·ªõp 'incorrect' ƒë·ªÉ ƒë·ªïi m√†u v√† rung l·∫Øc
                    // Ch·ªâ tr·ª´ ƒëi·ªÉm n·∫øu ƒëi·ªÉm s·ªë hi·ªán t·∫°i l·ªõn h∆°n 0
                    if (this.score > 0) { 
                        this.score = Math.max(0, this.score - 5); // Tr·ª´ 5 ƒëi·ªÉm nh∆∞ng kh√¥ng d∆∞·ªõi 0
                    }
                    // X√≥a l·ªõp 'incorrect' sau m·ªôt kho·∫£ng th·ªùi gian
                    setTimeout(() => {
                        selectedCellElement.classList.remove('incorrect');
                    }, 1000);
                }
                
                // C·∫≠p nh·∫≠t c√°c ch·ªâ s·ªë th·ªëng k√™ tr√™n giao di·ªán
                this.updateStats();
            }

            /**
             * V√¥ hi·ªáu h√≥a ho·∫∑c k√≠ch ho·∫°t l∆∞·ªõi pinyin.
             * @param {boolean} disable - True ƒë·ªÉ v√¥ hi·ªáu h√≥a, False ƒë·ªÉ k√≠ch ho·∫°t.
             */
            disablePinyinGrid(disable) {
                const cells = this.pinyinGridElement.children;
                for (let i = 0; i < cells.length; i++) {
                    if (!this.gridPinyinCellsData[i].isHidden) { // Ch·ªâ v√¥ hi·ªáu h√≥a c√°c √¥ kh√¥ng b·ªã ·∫©n
                        if (disable) {
                            cells[i].classList.add('disabled');
                        } else {
                            cells[i].classList.remove('disabled');
                        }
                    }
                }
            }

            /**
             * C·∫≠p nh·∫≠t c√°c ch·ªâ s·ªë th·ªëng k√™ tr√™n giao di·ªán ng∆∞·ªùi d√πng.
             */
            updateStats() {
                this.scoreElement.textContent = this.score;
                this.progressElement.textContent = `${this.correctAnswers}/${this.words.length}`;
                
                // T√≠nh to√°n ƒë·ªô ch√≠nh x√°c
                const accuracy = this.totalAttempts > 0 ? 
                    Math.round((this.correctAnswers / this.totalAttempts) * 100) : 0;
                this.accuracyElement.textContent = `${accuracy}%`;
                
                // C·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô
                const progressPercent = (this.correctAnswers / this.words.length) * 100;
                this.progressFillElement.style.width = `${progressPercent}%`;
            }

            /**
             * K·∫øt th√∫c tr√≤ ch∆°i khi ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c t·ª´.
             */
            endGame() {
                this.gameStarted = false;
                this.isPlaying = false;
                this.chineseTextDisplay.textContent = 'Ho√†n th√†nh!';
                this.meaningDisplay.textContent = 'Tuy·ªát v·ªùi!';
                this.startBtn.style.display = 'none'; // ·∫®n n√∫t "B·∫Øt ƒë·∫ßu"
                this.newGameBtn.style.display = 'inline-block'; // Hi·ªÉn th·ªã n√∫t "Ch∆°i l·∫°i"
                
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.currentAudio = null;
                }

                this.attemptCount++; // TƒÉng s·ªë l·∫ßn ho√†n th√†nh game

                // Hi·ªÉn th·ªã modal k·∫øt qu·∫£
                this.showResult();
            }

            /**
             * Hi·ªÉn th·ªã modal k·∫øt qu·∫£ cu·ªëi c√πng c·ªßa tr√≤ ch∆°i.
             */
            showResult() {
                const accuracy = this.totalAttempts > 0 ? 
                    Math.round((this.correctAnswers / this.totalAttempts) * 100) : 0;
                
                this.resultTitle.textContent = this.studentName;
                this.finalScore.textContent = this.score;
                this.finalAccuracy.textContent = `${accuracy}%`;
                this.totalAttemptsModal.textContent = this.totalAttempts;
                this.finalAttemptCount.textContent = this.attemptCount;

                const practiceName = CONFIG.practices.find(p => p.id === this.currentPracticeId)?.name || this.currentPracticeId;
                this.finalPracticeName.textContent = practiceName;
                
                // Thay ƒë·ªïi m√†u s·∫Øc ƒë·ªô ch√≠nh x√°c d·ª±a tr√™n gi√° tr·ªã
                this.finalAccuracy.className = 'result-stat-value ' + 
                    (accuracy >= 80 ? 'accuracy-high' : 
                     accuracy >= 60 ? 'accuracy-medium' : 'accuracy-low');
                
                let personalMsg = '';
                let overallMsg = '';

                if (accuracy >= 90) {
                    personalMsg = `Ch√∫c m·ª´ng ${this.studentName}! K·∫øt qu·∫£ xu·∫•t s·∫Øc!`;
                    overallMsg = 'üéâ B·∫°n ƒë√£ th√†nh th·∫°o pinyin c·ªßa b√†i n√†y!';
                } else if (accuracy >= 70) {
                    personalMsg = `T·ªët l·∫Øm ${this.studentName}! B·∫°n ƒëang ti·∫øn b·ªô!`;
                    overallMsg = 'üëç Kh√° t·ªët! H√£y ti·∫øp t·ª•c luy·ªán t·∫≠p ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm cao h∆°n!';
                } else if (accuracy >= 50) {
                    personalMsg = `${this.studentName}, h√£y c·ªë g·∫Øng th√™m nh√©!`;
                    overallMsg = 'üìö C·∫ßn c·∫£i thi·ªán th√™m. H√£y √¥n t·∫≠p v√† th·ª≠ l·∫°i!';
                } else {
                    personalMsg = `${this.studentName}, ƒë·ª´ng n·∫£n l√≤ng!`;
                    overallMsg = 'üí™ C·∫ßn luy·ªán t·∫≠p nhi·ªÅu h∆°n. H√£y √¥n t·∫≠p k·ªπ v√† th·ª≠ l·∫°i!';
                }

                this.personalMessage.textContent = personalMsg;
                this.overallMessage.textContent = overallMsg;

                this.resultModal.style.display = 'flex'; // Hi·ªÉn th·ªã modal
            }

            /**
             * ƒê·∫∑t l·∫°i tr√≤ ch∆°i v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu ƒë·ªÉ ch∆°i l·∫°i.
             */
            resetGame() {
                this.resultModal.style.display = 'none'; // ·∫®n modal k·∫øt qu·∫£
                
                this.currentWordIndex = 0;
                this.score = 0;
                this.correctAnswers = 0;
                this.totalAttempts = 0;
                this.gameStarted = false;
                this.isPlaying = false;
                
                this.chineseTextDisplay.textContent = 'B·∫•m "B·∫Øt ƒë·∫ßu"';
                this.meaningDisplay.textContent = 'ƒë·ªÉ ch∆°i';
                this.startBtn.style.display = 'inline-block'; // Hi·ªÉn th·ªã n√∫t "B·∫Øt ƒë·∫ßu"
                this.newGameBtn.style.display = 'none'; // ·∫®n n√∫t "Ch∆°i l·∫°i"
                
                this.shuffleWords(); // Tr·ªôn l·∫°i th·ª© t·ª± t·ª´ cho game m·ªõi
                this.prepareAndRenderInitialGrid(); // Chu·∫©n b·ªã v√† render l·∫°i l∆∞·ªõi ban ƒë·∫ßu
                this.updateStats(); // C·∫≠p nh·∫≠t th·ªëng k√™ v·ªÅ 0
            }

            /**
             * Quay l·∫°i m√†n h√¨nh ch·ªçn b√†i h·ªçc.
             */
            backToSelection() {
                this.resultModal.style.display = 'none'; // ·∫®n modal k·∫øt qu·∫£
                this.hideElement(this.gameSection);
                this.showElement(this.practiceSelector);

                // Reset game state completely
                this.words = [];
                this.currentWordIndex = 0;
                this.score = 0;
                this.correctAnswers = 0;
                this.totalAttempts = 0;
                this.gameStarted = false;
                this.isPlaying = false;
                this.currentAudio = null;
                this.studentName = '';
                this.currentPracticeId = '';
                this.attemptCount = 0;
                this.gridPinyinCellsData = [];

                this.studentNameInput.value = '';
                this.practiceDropdown.value = '';
                this.hideElement(this.practiceInfoDisplay);
                this.hideError();
                this.startBtn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t B·∫Øt ƒë·∫ßu
                this.chineseTextDisplay.textContent = 'B·∫•m "T·∫£i B√†i"';
                this.meaningDisplay.textContent = 'ƒë·ªÉ b·∫Øt ƒë·∫ßu';
                this.updateStats(); // C·∫≠p nh·∫≠t th·ªëng k√™ v·ªÅ 0
                this.renderPinyinGrid(); // X√≥a l∆∞·ªõi pinyin
            }

            /**
             * X√°o tr·ªôn ng·∫´u nhi√™n th·ª© t·ª± c√°c t·ª´ trong m·∫£ng this.words.
             * S·ª≠ d·ª•ng thu·∫≠t to√°n Fisher-Yates shuffle.
             */
            shuffleWords() {
                for (let i = this.words.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.words[i], this.words[j]] = [this.words[j], this.words[i]];
                }
            }
        }

        // Kh·ªüi t·∫°o game khi trang web ƒë∆∞·ª£c t·∫£i
        const game = new PinyinGame();

        // T·ªëi ∆∞u h√≥a cho thi·∫øt b·ªã c·∫£m ·ª©ng
        function setupTouchOptimizations() {
            const addTouchFeedback = (element) => {
                element.addEventListener('touchstart', function() {
                    this.style.opacity = '0.8';
                }, { passive: true });
                
                element.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                }, { passive: true });
                
                element.addEventListener('touchcancel', function() {
                    this.style.opacity = '1';
                }, { passive: true });
            };

            document.querySelectorAll('button, .pinyin-cell').forEach(addTouchFeedback);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            game.initializePracticeSelector(); // ƒê·∫£m b·∫£o dropdown ƒë∆∞·ª£c ƒëi·ªÅn khi t·∫£i trang
            setupTouchOptimizations();
        });

        // Cleanup when page unloads
        window.addEventListener('beforeunload', function() {
            if (game.currentAudio) {
                game.currentAudio.pause();
            }
        });

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                window.scrollTo(0, 0);
            }, 100);
        });
    </script>
</body>
</html>
